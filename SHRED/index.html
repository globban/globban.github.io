<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHRED | Elite Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { background-color: #000; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; touch-action: manipulation; }
        .stat-card { background: #0b0b0b; border: 1px solid #151515; border-radius: 1.5rem; padding: 1.25rem; }
        .btn-shred { background: #39FF14; color: #000; box-shadow: 0 0 30px rgba(57, 255, 20, 0.2); transition: all 0.2s ease; position: absolute; bottom: 20px; left: 0px;}
        #map { height: 200px; width: 100%; border-radius: 1.5rem; background: #000; border: 1px solid #222; margin: 1rem 0; }
        .page { display: none; height: 92vh; flex-direction: column; overflow-y: auto; scrollbar-width: none; }
        .page::-webkit-scrollbar { display: none; }
        .active-page { display: flex; }
        #pocket-shield { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .lock-indicator { color: #080808; font-size: 8px; font-weight: 900; letter-spacing: 0.5em; text-transform: uppercase; pointer-events: none; }
        input[type="text"] { background: #111; border: 1px solid #222; color: #fff; border-radius: 1rem; padding: 1rem; outline: none; text-align: center; font-weight: 800; width: 100%; transition: border 0.2s; }
        input[type="text"]:focus { border-color: #39FF14; }
        input[type="range"] { accent-color: #39FF14; }
        #pfp-input { font-size: 4rem; width: 120px; height: 120px; padding: 0; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="p-4" onclick="handleInitialTap()">

    <div id="pocket-shield" onclick="handlePocketTap()">
        <p class="lock-indicator">Triple Tap To Return</p>
    </div>

    <div class="flex justify-between items-center mb-4 z-50">
        <div class="flex gap-2">
            <button onclick="showPage('leaderboard-page')" class="p-3 bg-zinc-900 rounded-2xl active:scale-90 transition-transform">
                <i data-lucide="trophy" class="text-[#39FF14] w-5 h-5"></i>
            </button>
            <button onclick="showPage('profile-page')" class="p-3 bg-zinc-900 rounded-2xl flex items-center gap-2 active:scale-90 transition-transform">
                <span id="nav-pfp">⛷️</span>
                <span id="nav-user" class="text-[10px] font-black uppercase tracking-tighter hidden sm:inline">RIDER</span>
            </button>
        </div>
        <div class="flex items-center gap-3">
            <div id="connection-dot" class="w-2 h-2 rounded-full bg-red-600"></div>
            
        </div>
    </div>

    <div id="tracking-page" class="page active-page">
        <div class="text-center py-6">
            <p class="text-gray-600 text-[10px] font-black uppercase tracking-[0.4em] mb-2 text-center w-full">Max Session Speed</p>
            <h1 id="live-top-speed" class="text-9xl font-black italic tracking-tighter text-[#39FF14]">0.0</h1>
            <p class="text-gray-500 text-sm font-bold uppercase tracking-widest text-center w-full">km/h</p>

        </div>

        <div class="stat-card space-y-4 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Gps Sync</span>
                <span id="interval-display" class="text-[#39FF14] font-mono font-bold">1.0s</span>
            </div>
            <input id="acc-slider" type="range" min="0.1" max="5.0" step="0.1" value="1.0" class="w-full" oninput="updateIntervalDisplay(this.value)">
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="stat-card flex flex-col items-center">
                <span class="text-[9px] font-black text-gray-600 uppercase mb-1">Live</span>
                <span class="text-2xl font-black italic"><span id="curr-speed">0.0</span></span>
            </div>
            <div class="stat-card flex flex-col items-center">
                <span class="text-[9px] font-black text-gray-600 uppercase mb-1">Alt</span>
                <span class="text-2xl font-black italic"><span id="curr-alt">--</span>m</span>
            </div>
        </div>
        <button id="lock-btn" onclick="activateLock()" class="text-[10px] bg-zinc-900 border border-zinc-800 text-gray-400 px-4 py-2 rounded-full font-black uppercase tracking-widest" style="height: 10%; background-color: #010101;">Lock<i data-lucide="lock" class="w-3 h-3 ml-1"></i></button>
        <button id="main-btn" onclick="toggleTracking()" class="btn-shred w-full py-6 rounded-[2rem] font-black text-xl uppercase tracking-widest mt-auto">Start Shredding</button>
    </div>

    <div id="profile-page" class="page">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-black italic uppercase tracking-tighter">Identity</h2>
            <button onclick="showPage('tracking-page')" class="p-2 bg-zinc-900 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div class="flex flex-col items-center gap-6">
            <input id="pfp-input" type="text" maxlength="2" placeholder="⛷️">
            <div class="w-full space-y-2">
                <p class="text-gray-600 text-[10px] font-black uppercase tracking-widest ml-2">Username</p>
                <input id="username-input" type="text" maxlength="12" placeholder="RIDER NAME">
            </div>
        </div>
        <button onclick="saveProfile()" class="bg-[#39FF14] text-black w-full py-5 rounded-3xl font-black uppercase tracking-widest mt-auto mb-4">Save Profile</button>
    </div>

    <div id="leaderboard-page" class="page">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-black italic uppercase tracking-tighter">Global Peaks</h2>
            <button onclick="showPage('tracking-page')" class="p-2 bg-zinc-900 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div id="leaderboard-content" class="space-y-2 pb-20"></div>
    </div>

    <div id="summary-page" class="page">
        <h2 class="text-3xl font-black italic uppercase tracking-tighter">Run Summary</h2>
        <div id="map"></div>
        <div class="stat-card flex justify-between items-center mb-4">
            <div><p class="text-gray-600 text-[10px] font-black uppercase">Max Speed</p><p id="sum-max" class="text-5xl font-black italic text-[#39FF14]">0.0</p></div>
            <span class="text-gray-500 font-black italic text-xl">KMH</span>
        </div>
        <button onclick="softReset()" class="bg-white text-black w-full py-5 rounded-3xl font-black uppercase tracking-widest mt-auto mb-4">New Session</button>
    </div>

    <script>
        lucide.createIcons();
        
        // --- JSONBIN CONFIG ---
        const BIN_ID = "699dfe98d0ea881f40d5dbc7";
        const API_KEY = "$2a$10$/ixw5jkkHC.ZGSRfFRuDKui80wjbSFtxiGyA2mgw2L.58/CHwNsVK";
        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let userProfile = JSON.parse(localStorage.getItem('shred_profile')) || { name: 'Rider', emoji: '⛷️' };
        let isTracking = false, watchId = null, dataPoints = [], maxSpeed = 0, totalDistance = 0, wakeLock = null;
        let tapCount = 0, tapTimer = null;

        function init() {
            document.getElementById('nav-user').innerText = userProfile.name;
            document.getElementById('nav-pfp').innerText = userProfile.emoji;
            document.getElementById('pfp-input').value = userProfile.emoji;
            document.getElementById('username-input').value = userProfile.name;
            fetchLeaderboard();
        }

        async function postScore(speed) {
            try {
                // 1. Get current leaderboard
                const res = await fetch(BASE_URL, { headers: { "X-Master-Key": API_KEY }});
                const data = await res.json();
                let list = data.record.scores || [];

                // 2. Update or Add
                const existingIdx = list.findIndex(r => r.name === userProfile.name);
                if (existingIdx > -1) {
                    if (speed > list[existingIdx].speed) list[existingIdx] = { ...userProfile, speed: speed };
                } else {
                    list.push({ ...userProfile, speed: speed });
                }

                // 3. Sort and Limit top 50
                list.sort((a, b) => b.speed - a.speed);
                list = list.slice(0, 50);

                // 4. Save back
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                    body: JSON.stringify({ scores: list })
                });
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-[#39FF14] shadow-[0_0_8px_#39FF14]";
            } catch (e) { console.error(e); }
        }

        async function fetchLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            container.innerHTML = `<p class="text-center py-20 text-gray-500 animate-pulse">Syncing...</p>`;
            try {
                const res = await fetch(BASE_URL, { headers: { "X-Master-Key": API_KEY }});
                const data = await res.json();
                const list = data.record.scores || [];
                
                container.innerHTML = "";
                list.forEach((entry, i) => {
                    const div = document.createElement('div');
                    div.className = "stat-card flex items-center gap-4 mb-2 border-l-4 " + (i<3 ? 'border-[#39FF14]' : 'border-transparent');
                    div.innerHTML = `
                        <span class="text-xs font-black text-gray-700 w-4">#${i+1}</span>
                        <span class="text-2xl">${entry.emoji}</span>
                        <div class="flex-1 overflow-hidden"><p class="text-sm font-black uppercase truncate">${entry.name}</p></div>
                        <p class="text-xl font-black italic text-[#39FF14]">${entry.speed.toFixed(1)}<span class="text-[8px] text-gray-600 ml-1">KMH</span></p>
                    `;
                    container.appendChild(div);
                });
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-[#39FF14] shadow-[0_0_8px_#39FF14]";
            } catch (e) { container.innerHTML = "Offline."; }
        }

        function saveProfile() {
            const emojiArr = Array.from(document.getElementById('pfp-input').value.trim());
            userProfile.emoji = emojiArr.length ? emojiArr[0] : "⛷️";
            userProfile.name = document.getElementById('username-input').value.trim() || "Rider";
            localStorage.setItem('shred_profile', JSON.stringify(userProfile));
            init(); showPage('tracking-page');
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            if(id === 'leaderboard-page') fetchLeaderboard();
        }

        function handleInitialTap() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); }
        function activateLock() { document.getElementById('pocket-shield').style.display = 'flex'; }
        function handlePocketTap() {
            tapCount++; clearTimeout(tapTimer);
            if (tapCount === 3) { document.getElementById('pocket-shield').style.display = 'none'; tapCount = 0; }
            else { tapTimer = setTimeout(() => { tapCount = 0; }, 600); }
        }

        function updateIntervalDisplay(val) { document.getElementById('interval-display').innerText = parseFloat(val).toFixed(1) + "s"; }

        function toggleTracking() { isTracking ? stopTracking() : startTracking(); }

        async function startTracking() {
    // 1. Request Wake Lock to keep CPU alive
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }

    // 2. Audio Hack (Keeps process alive on iOS/Android in pocket)
    const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
    silentAudio.loop = true;
    silentAudio.play().catch(() => console.log("Audio needs user interaction first"));

    isTracking = true;
    dataPoints = [];
    maxSpeed = 0;
    
    const btn = document.getElementById('main-btn');
    btn.innerText = "End Run";
    btn.style.background = "#ff3b3b";
    
    // 3. High-Reliability Watch Configuration
    const geoOptions = {
        enableHighAccuracy: true, // Forces GPS hardware
        maximumAge: 0,            // Don't use cached location
        timeout: 5000             // Timeout if no lock in 5s
    };

    let speedBuffer = []; // For smoothing

    watchId = navigator.geolocation.watchPosition(pos => {
        // Filter out low accuracy (over 20m error is usually trash data)
        if (pos.coords.accuracy > 20) return;

        let rawKmh = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
        
        // 4. Speed Smoothing (Last 3 samples)
        speedBuffer.push(rawKmh);
        if (speedBuffer.length > 3) speedBuffer.shift();
        const smoothedKmh = speedBuffer.reduce((a, b) => a + b) / speedBuffer.length;

        if (smoothedKmh > maxSpeed) maxSpeed = smoothedKmh;

        dataPoints.push({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            alt: pos.coords.altitude,
            speed: smoothedKmh
        });

        // UI Updates
        document.getElementById('curr-speed').innerText = smoothedKmh.toFixed(1);
        document.getElementById('live-top-speed').innerText = maxSpeed.toFixed(1);
        document.getElementById('curr-alt').innerText = pos.coords.altitude ? Math.round(pos.coords.altitude) : "--";
        
    }, (err) => {
        console.warn(`GPS Error: ${err.message}`);
    }, geoOptions);
}

        function stopTracking() {
            isTracking = false; if (wakeLock) wakeLock.release();
            navigator.geolocation.clearWatch(watchId);
            postScore(maxSpeed);
            document.getElementById('sum-max').innerText = maxSpeed.toFixed(1);
            showPage('summary-page');
            setTimeout(initMap, 200);
        }

        function softReset() {
            document.getElementById('main-btn').style.background = "#39FF14"; document.getElementById('main-btn').style.color = "#000";
            document.getElementById('main-btn').innerText = "Start Shredding";
            showPage('tracking-page');
        }

        function initMap() {
            if (!dataPoints.length) return;
            const mapContainer = L.DomUtil.get('map');
            if (mapContainer != null) mapContainer._leaflet_id = null;
            const map = L.map('map', { zoomControl: false }).setView([dataPoints[0].lat, dataPoints[0].lng], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.polyline(dataPoints.map(p => [p.lat, p.lng]), { color: '#39FF14', weight: 6 }).addTo(map);
            map.fitBounds(L.polyline(dataPoints.map(p => [p.lat, p.lng])).getBounds(), { padding: [20, 20] });
        }

        init();
    </script>
</body>
</html>