<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drift</title>
  <script src="https://kit.fontawesome.com/87a560d2c6.js" crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #333;
      overflow: hidden;
    }
    canvas {
      display: block;
      background: #555;
      width: 100vw;
      height: 100vh;
    }
    #colorMenu {
      position: absolute;
      bottom: 10vh;
      left: 50%;
      transform: translateX(-50%);
      width: 80vw;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-family: sans-serif;
      font-size: 25px;
      display: none;
    }
    #colorMenu input[type="range"] {
      width: 80vw;
      height: 6vh;
    }
    #menubutton {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: transparent;
      color: #ffffff;
      font-size: 69px;
      z-index: 1000;
      cursor: pointer;
    }
    #mobile-only {
      display: none;
    }
    .touch-only {
      display: block;
    }
    #watermark {
      position: absolute;
      top: 10px;
      right: 20px;
      color: #aaa;
      font-size: 20px;
      font-family: 'Courier New', Courier, monospace;
    }
    h1 {
      position: absolute;
      color: #fff;
      z-index: 999;
      top: 50vh;
      left: 50vw;
      transform: translate(-50%, -50%);
      font-family: 'Courier New', Courier, monospace;
      font-size: 3em;
    }
    #mobileControls button {
      width: 45vw;
      height: 100vh;
      font-size: 2em;
      margin: 5px;
      border-radius: 10px;
      border: none;
      background-color: #22222200;
      color: #ffffff10;
    }
    #mobileControls {
      position: absolute;
      bottom: 0px;
      width: 100vw;
      text-align: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="menubutton" onclick="menu()"><i class="fas fa-fill-drip"></i></div>
  <div id="watermark">Algots drift workshop</div>

  <div id="colorMenu">
    <label for="hueSlider">Car Hue:</label>
    <input type="range" id="hueSlider" min="0" max="360" value="0"><br>
    <label for="saturationSlider">Saturation:</label>
    <input type="range" id="saturationSlider" min="0" max="200" value="100"><br>
    <label for="brightnessSlider">Brightness:</label>
    <input type="range" id="brightnessSlider" min="0" max="200" value="100">
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="mobile-only" class="touch-only">
    <div id="mobileControls">
      <div id="start">
        <h1>Press to Start</h1>
      </div>
      <button id="leftBtn">Left</button>
      <button id="rightBtn">Right</button>
    </div>
  </div>

  <script>
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");

    const hueSlider = document.getElementById("hueSlider");
    const saturationSlider = document.getElementById("saturationSlider");
    const brightnessSlider = document.getElementById("brightnessSlider");

    const keys = {};

    leftBtn.addEventListener("touchstart", e => {
      e.preventDefault();
      keys["ArrowLeft"] = true;
      keys["ArrowUp"] = true;
      document.getElementById("start").style.display = "none";
    });
    leftBtn.addEventListener("touchend", e => {
      e.preventDefault();
      keys["ArrowLeft"] = false;
    });

    rightBtn.addEventListener("touchstart", e => {
      e.preventDefault();
      keys["ArrowRight"] = true;
      keys["ArrowUp"] = true;
      document.getElementById("start").style.display = "none";
    });
    rightBtn.addEventListener("touchend", e => {
      e.preventDefault();
      keys["ArrowRight"] = false;
    });

    const config = {
      baseCar: { w: 47, h: 100, pivotOffset: 30 },
      baseWheelbase: 57,
      maxSpeed: 14,
      friction: 0.98,
      accelFwd: 0.07,
      accelBack: -0.03,
      steeringRate: 0.02,
      maxSteer: 0.5,
      driftFactor: 0.01,
      carSrc: 'car.png',
      hitboxScale: 0.85,
      hue: 0,
      saturation: 100,
      brightness: 100
    };

    const savedHue = localStorage.getItem("carHue");
    if (savedHue !== null) {
      config.hue = savedHue;
      hueSlider.value = savedHue;
    }
    const savedSaturation = localStorage.getItem("carSaturation");
    if (savedSaturation !== null) {
      config.saturation = savedSaturation;
      saturationSlider.value = savedSaturation;
    }
    const savedBrightness = localStorage.getItem("carBrightness");
    if (savedBrightness !== null) {
      config.brightness = savedBrightness;
      brightnessSlider.value = savedBrightness;
    }

    hueSlider.addEventListener("input", e => {
      config.hue = e.target.value;
      localStorage.setItem("carHue", config.hue);
    });
    saturationSlider.addEventListener("input", e => {
      config.saturation = e.target.value;
      localStorage.setItem("carSaturation", config.saturation);
    });
    brightnessSlider.addEventListener("input", e => {
      config.brightness = e.target.value;
      localStorage.setItem("carBrightness", config.brightness);
    });

    function menu() {
      const colorMenu = document.getElementById("colorMenu");
      colorMenu.style.display = colorMenu.style.display === "block" ? "none" : "block";
    }

    if (!window.matchMedia('(any-hover: hover)').matches && 'ontouchstart' in window) {
      document.getElementById('mobile-only').style.display = "block";
    }

    const BASE_RES = { width: 1920, height: 1080 };
    let scale = 1;
    let dpr = 1;
    let obstacles = [];
    const baseObstacles = [
      { x:-400, y:-300, w:80, h:80 }, { x:-200, y:-200, w:120, h:50 }, { x:0, y:-350, w:100, h:100 },
      { x:300, y:-150, w:90, h:60 }, { x:-350, y:100, w:110, h:110 }, { x:-500, y:200, w:100, h:70 },
      { x:200, y:250, w:80, h:80 }, { x:450, y:0, w:100, h:100 }, { x:-150, y:400, w:90, h:60 },
      { x:250, y:-100, w:110, h:90 }, { x:-300, y:-450, w:80, h:80 }, { x:50, y:450, w:120, h:70 }
    ];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const carImg = new Image(); carImg.src = config.carSrc;

    function resize() {
  dpr = devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  scale = Math.min(window.innerWidth / BASE_RES.width, window.innerHeight / BASE_RES.height);

  const cx = canvas.width / 4, cy = canvas.height / 4;

  // Scale obstacles appropriately
  obstacles = generateRandomObstacles(12).map(o => ({
    x: cx + o.x * scale * dpr,
    y: cy + o.y * scale * dpr,
    width: o.width * scale * dpr,
    height: o.height * scale * dpr,
    angle: o.angle
  }));

  config.scaledMaxSpeed = config.maxSpeed * scale * dpr;
  config.scaledAccelFwd = config.accelFwd * scale * dpr;
  config.scaledAccelBack = config.accelBack * scale * dpr;
}


    window.addEventListener('resize', resize);

    const car = { x:0, y:0, angle:Math.PI/2, vAngle:Math.PI/2, velocity:0, steering:0 };
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => keys[e.key] = false);

    function update() {
  if (document.getElementById('mobile-only').style.display === "block") {
    keys.ArrowUp = true;
  }

  let accel = 0;
  if (keys.ArrowUp || keys.w || keys.W) accel = config.scaledAccelFwd;
  else if (keys.ArrowDown || keys.s || keys.S) accel = config.scaledAccelBack;

  car.velocity = (car.velocity + accel) * config.friction;
  car.velocity = Math.max(-config.scaledMaxSpeed/2, Math.min(config.scaledMaxSpeed, car.velocity));

  if (keys.ArrowLeft || keys.a || keys.A) car.steering -= config.steeringRate;
  else if (keys.ArrowRight || keys.d || keys.D) car.steering += config.steeringRate;
  else car.steering *= 0.5;
  car.steering = Math.max(-config.maxSteer, Math.min(config.maxSteer, car.steering));

  car.angle += (car.velocity / (config.baseWheelbase * scale * dpr)) * Math.tan(car.steering);
  car.vAngle += (car.angle - car.vAngle) * config.driftFactor;

  car.x += car.velocity * Math.cos(car.vAngle);
  car.y += car.velocity * Math.sin(car.vAngle);

  checkCollision(); // <-- ðŸ’¥ Call collision check here

  if (car.x<0) car.x=canvas.width;
  if (car.x>canvas.width) car.x=0;
  if (car.y<0) car.y=canvas.height;
  if (car.y>canvas.height) car.y=0;
}


function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#888';
  obstacles.forEach(o => ctx.fillRect(o.x, o.y, o.width, o.height));

  if (carImg.complete) {
    const w = config.baseCar.w * scale * dpr;
    const h = config.baseCar.h * scale * dpr;
    const pivot = config.baseCar.pivotOffset * scale * dpr;
    ctx.save();
    ctx.translate(car.x, car.y);
    ctx.rotate(car.angle + Math.PI/2);

    ctx.filter = `hue-rotate(${config.hue}deg) saturate(${config.saturation}%) brightness(${config.brightness}%)`;
    ctx.drawImage(carImg, -w/2, -h/2 - pivot, w, h);
    ctx.filter = 'none';

    // Draw hitbox
    const hitboxW = w * config.hitboxScale;
    const hitboxH = h * config.hitboxScale;
    ctx.strokeStyle = '#00000000';
    ctx.lineWidth = 3;
    ctx.globalAlpha = 0.7;
    ctx.strokeRect(-hitboxW/2, -hitboxH/2 - pivot, hitboxW, hitboxH);
    ctx.globalAlpha = 1;

    ctx.restore();
  }
}

function checkCollision() {
  const w = config.baseCar.w * scale * dpr * config.hitboxScale;
  const h = config.baseCar.h * scale * dpr * config.hitboxScale;
  const pivot = config.baseCar.pivotOffset * scale * dpr;

  // Car corners in world space
  const sin = Math.sin(car.angle + Math.PI/2);
  const cos = Math.cos(car.angle + Math.PI/2);

  const carCorners = [
    { x: car.x + (-w/2) * cos - (-h/2 - pivot) * sin, y: car.y + (-w/2) * sin + (-h/2 - pivot) * cos },
    { x: car.x + (w/2) * cos - (-h/2 - pivot) * sin, y: car.y + (w/2) * sin + (-h/2 - pivot) * cos },
    { x: car.x + (w/2) * cos - (h/2 - pivot) * sin, y: car.y + (w/2) * sin + (h/2 - pivot) * cos },
    { x: car.x + (-w/2) * cos - (h/2 - pivot) * sin, y: car.y + (-w/2) * sin + (h/2 - pivot) * cos }
  ];

  for (const o of obstacles) {
    for (const corner of carCorners) {
      if (
        corner.x > o.x &&
        corner.x < o.x + o.width &&
        corner.y > o.y &&
        corner.y < o.y + o.height
      ) {
        // Hit! Bounce back
        car.velocity = -car.velocity * 0.3;
        return;
      }
    }
  }
}

function generateRandomObstacles(numObstacles) {
  const minSize = 50; // Minimum size of obstacles
  const maxSize = 150; // Maximum size of obstacles
  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;

  const generatedObstacles = [];

  for (let i = 0; i < numObstacles; i++) {
    const width = Math.random() * (maxSize - minSize) + minSize;
    const height = Math.random() * (maxSize - minSize) + minSize;

    // Correct placement of obstacles across the full screen
    const x = Math.random() * (canvasWidth - width);
    const y = Math.random() * (canvasHeight - height);

    const angle = Math.random() * Math.PI * 2; // Random angle for the obstacle

    generatedObstacles.push({ x, y, width, height, angle });
  }

  return generatedObstacles;
}




    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    resize();
    car.x = canvas.width/2;
    car.y = canvas.height/2;
    loop();
  </script>
</body>
</html>
