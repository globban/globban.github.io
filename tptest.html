<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #0a0a15, #1a1a2e, #16213e);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #fff;
      }

      .container {
        background: rgba(10, 10, 20, 0.346);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 40px;
        width: 100%;
        max-width: 500px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      h1 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .test-state {
        text-align: center;
        font-size: 14px;
        color: #999;
        margin-bottom: 20px;
        height: 20px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: rgba(10, 10, 20, 0.346);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        border-color: rgba(102, 126, 234, 0.4);
        background: rgba(102, 126, 234, 0.1);
      }

      .metric-label {
        font-size: 12px;
        text-transform: uppercase;
        color: #999;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .gauge-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto 20px;
      }

      .speedometer {
        width: 100%;
        height: auto;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
      }

      #speedArc {
        filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.8));
        transition: d 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
      }

      .progress-bar {
        width: 100%;
        height: 6px;
         background: rgba(10, 10, 20, 0.346);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.2s linear;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        flex: 1;
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        flex: 2;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
        border: 1px solid #667eea;
      }

      .btn-secondary:hover:not(:disabled) {
        background: rgba(102, 126, 234, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .info-text {
        font-size: 12px;
        color: #666;
        text-align: center;
        margin-top: 20px;
      }

      .stats-detail {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-size: 13px;
      }

      .stat-label {
        color: #999;
      }

      .stat-value {
        color: #667eea;
        font-weight: 600;
      }

      @media (max-width: 480px) {
        .container {
          padding: 24px;
        }

        h1 {
          font-size: 22px;
          margin-bottom: 20px;
        }

        .metrics-grid {
          gap: 12px;
          margin-bottom: 20px;
        }

        .metric-card {
          padding: 12px;
        }

        .metric-value {
          font-size: 20px;
        }

        .large-metric .metric-value {
          font-size: 32px;
        }
      }

      #bg {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
        border: none;
      }
    </style>
  </head>
  <body>
    <iframe id="bg" src="/topo.html"></iframe>

    <div class="container">
      <h1>Speed Test</h1>

      <div class="test-state" id="testState">Ready to test</div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="gauge-container">
        <svg class="speedometer" viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet">
          <!-- Background arc -->
          <path d="M 20 100 A 80 80 0 0 1 180 100" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none" stroke-linecap="round"/>
          <!-- Speed arc -->
          <path id="speedArc" d="M 20 100 A 80 80 0 0 1 20 100" stroke="#667eea" stroke-width="8" fill="none" stroke-linecap="round"/>
          <!-- Speed value -->
          <text id="speedText" x="100" y="95" text-anchor="middle" font-size="32" font-weight="600" fill="#667eea">—</text>
          <text x="100" y="110" text-anchor="middle" font-size="14" fill="#999">Mbps</text>
        </svg>
      </div>
      <div class="metric-label" style="text-align: center; margin-top: 12px;">
        <span id="downloadData">0</span> MB
      </div>

      <div class="button-group">
        <button class="btn-primary" id="startBtn" onclick="startTest()">Start Test</button>
        <button class="btn-secondary" id="resetBtn" onclick="resetTest()">Reset</button>
      </div>
    </div>
  
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

  <script>
    // ============ Configuration ============
    const CONFIG = {
      WARMUP_TIME: 1000,
      INTERVAL_MS: 200,
      DOWNLOAD_URL: 'https://speed.cloudflare.com/__down?bytes=100000000',
      THREADS: 8,
    };

    // ============ State ============
    let state = {
      isRunning: false,
      downloadSamples: [],
      totalDownload: 0,
      lastDownload: 0,
      currentSpeed: 0,
      smoothedSpeed: 0,
    };

    // ============ UI Elements ============
    const UI = {
      startBtn: document.getElementById('startBtn'),
      resetBtn: document.getElementById('resetBtn'),
      testState: document.getElementById('testState'),
      progressFill: document.getElementById('progressFill'),
      downloadData: document.getElementById('downloadData'),
    };

    // ============ Download Test ============
    async function testDownload(duration) {
      state.totalDownload = 0;
      state.lastDownload = 0;
      state.downloadSamples = [];

      const controllers = Array.from({ length: CONFIG.THREADS }, () => new AbortController());
      const startTime = performance.now();

      const downloadPromises = controllers.map(async (ctrl) => {
        try {
          const url = CONFIG.DOWNLOAD_URL + '&_=' + Math.random();
          const response = await fetch(url, { signal: ctrl.signal });
          const reader = response.body.getReader();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            state.totalDownload += value.length;
          }
        } catch (e) {
          if (e.name !== 'AbortError') console.error('Download error:', e);
        }
      });

      const updateInterval = setInterval(() => {
        const elapsed = performance.now() - startTime;
        const delta = state.totalDownload - state.lastDownload;
        state.lastDownload = state.totalDownload;

        if (elapsed > CONFIG.WARMUP_TIME) {
          const mbps = (delta * 8) / (CONFIG.INTERVAL_MS / 1000) / 1_000_000;
          state.downloadSamples.push(mbps);
          if (state.downloadSamples.length > 15) state.downloadSamples.shift();
          
          // Smooth the speed transition with exponential moving average
          state.currentSpeed = mbps;
          state.smoothedSpeed += (state.currentSpeed - state.smoothedSpeed) * 0.15;
        }

        // Animate progress with smooth transition
        const pct = Math.min(100, (elapsed / duration) * 100);
        UI.progressFill.style.width = pct + '%';

        updateUI();
      }, CONFIG.INTERVAL_MS);

      await Promise.race([
        Promise.all(downloadPromises),
        sleep(duration)
      ]);

      controllers.forEach(c => c.abort());
      clearInterval(updateInterval);
    }

    // ============ Main Test Flow ============
    async function startTest() {
      if (state.isRunning) return;

      state.isRunning = true;
      state.downloadSamples = [];
      state.totalDownload = 0;
      state.lastDownload = 0;
      state.currentSpeed = 0;
      state.smoothedSpeed = 0;

      UI.startBtn.disabled = true;
      UI.resetBtn.disabled = true;
      UI.progressFill.style.width = '0%';

      const testDuration = 10000; // 10 seconds

      try {
        UI.testState.textContent = 'Testing speed...';
        await testDownload(testDuration);
      } catch (e) {
        console.error('Test error:', e);
        UI.testState.textContent = 'Test error: ' + e.message;
      } finally {
        finalizeTest();
      }
    }

    function updateUI() {
      const displaySpeed = state.smoothedSpeed.toFixed(2);
      document.getElementById('speedText').textContent = displaySpeed;
      UI.downloadData.textContent = (state.totalDownload / 1_000_000).toFixed(1);
      
      // Update speedometer arc (0-500 Mbps scale)
      const maxSpeed = 500;
      const percent = Math.min(100, (state.smoothedSpeed / maxSpeed) * 100);
      const angle = (percent / 100) * 180; // 0-180 degrees for semicircle
      const rad = (angle * Math.PI) / 180;
      const x = 100 + 80 * Math.cos(Math.PI - rad);
      const y = 100 - 80 * Math.sin(Math.PI - rad);
      const largeArc = angle > 90 ? 1 : 0;
      
      const pathData = `M 20 100 A 80 80 0 ${largeArc} 1 ${x} ${y}`;
      document.getElementById('speedArc').setAttribute('d', pathData);
    }

    function finalizeTest() {
      state.isRunning = false;
      UI.startBtn.disabled = false;
      UI.resetBtn.disabled = false;
      UI.testState.textContent = 'Test complete';
      UI.progressFill.style.width = '100%';
    }

    function resetTest() {
      if (state.isRunning) return;

      state = {
        isRunning: false,
        downloadSamples: [],
        totalDownload: 0,
        lastDownload: 0,
        currentSpeed: 0,
        smoothedSpeed: 0,
      };

      document.getElementById('speedText').textContent = '—';
      UI.downloadData.textContent = '0';
      UI.testState.textContent = 'Ready to test';
      UI.progressFill.style.width = '0%';
      UI.startBtn.disabled = false;
      
      // Reset arc to start
      document.getElementById('speedArc').setAttribute('d', 'M 20 100 A 80 80 0 0 1 20 100');
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initialize particles
    if (window.particlesJS) {
      particlesJS('particles-js', {
        particles: {
          number: { value: 80, density: { enable: true, value_area: 800 } },
          color: { value: '#667eea' },
          opacity: { value: 0.5 },
          size: { value: 3 },
          move: { enable: true, speed: 2 }
        }
      });
    }
  </script>

</body>
</html>
