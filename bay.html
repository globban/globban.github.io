<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Algot.fun</title>
  <link rel="icon" href="/favicon.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    @font-face {
      font-family: 'Dot';
      src: url('/dot.ttf');
    }

    body {
      overflow-x: hidden;
      overflow-y: auto;
      font-family: 'Dot', Arial, sans-serif;
      background: #000000;
      margin: 0;
    }

    header {
      color: white;
      text-align: center;
      font-size: 3vw;
      margin: 20px 0;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 50px;
      padding: 50px;
    }

    .card {
      position: relative;
      perspective: 1000px;
    }

    .card img {
      width: 100%;
      height: auto;
      border-radius: 15px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .card img:hover {
      box-shadow: 0 0px 30px rgb(225, 176, 255);
    }

    #iframe-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #close-btn {
      color: white;
      font-size: 2em;
      background: none;
      border: none;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #iframe-wrapper {
      position: relative;
      width: 80vw;
      height: 80vh;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }

    #game-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    #control-box {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 400px;
      height: 45px;
      background-color: #212232;
      z-index: 10;
    }

    #iframe-menu {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 45px;
      background: #212232;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 15px;
      box-sizing: border-box;
      z-index: 10;
    }

    #fullscreen-btn {
      background: none;
      color: white;
      border: 1px solid white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
      cursor: pointer;
    }

    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
  </style>
</head>
<body>
  <header>
    <h1>Welcome to the Game Bay</h1>
  </header>

  <div id="grid"></div>
  <div id="background"></div>

  <div id="iframe-popup">
    <button id="close-btn"><i class="fa fa-times"></i></button>
    <div id="iframe-wrapper">
      <iframe id="game-frame" allow="fullscreen" sandbox="allow-same-origin allow-scripts allow-pointer-lock"></iframe>
    </div>
  </div>

  <script type="module">
    import { createWireframeWater } from './wireframeWater.js';

    createWireframeWater({
      color: 0x8800ff,
      waveAmplitude: 0.3,
      waveFrequency: 0.1,
      container: document.getElementById('background')
    });

    const popup = document.getElementById('iframe-popup');
    const iframe = document.getElementById('game-frame');
    const closeBtn = document.getElementById('close-btn');
    const wrapper = document.getElementById('iframe-wrapper');
    const grid = document.getElementById('grid');

    // Load games from external JSON file
    const response = await fetch('./games.json');
    const games = await response.json();

    games.forEach(game => {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.src = game.thumbnail;
      img.alt = game.title || game.gameid;
      img.dataset.gameid = game.gameid;

      card.appendChild(img);
      grid.appendChild(card);

      img.addEventListener('click', () => {
        const id = img.dataset.gameid;
        const customUrl = game.customurl;

        // Set iframe src
        iframe.src = customUrl
          ? customUrl
          : `https://games.crazygames.com/en_US/${id}/index.html?skipPrerollFirstSession=true&v=1.337`;

        // Remove any existing controls
        const existingControl = document.getElementById('control-box');
        const existingMenu = document.getElementById('iframe-menu');
        if (existingControl) existingControl.remove();
        if (existingMenu) existingMenu.remove();

        // Add appropriate UI
        if (customUrl) {
          const menu = document.createElement('div');
          menu.id = 'iframe-menu';

          const fullscreenBtn = document.createElement('button');
          fullscreenBtn.id = 'fullscreen-btn';
          fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i> Fullscreen';

          let isFullscreen = false;
          fullscreenBtn.addEventListener('click', () => {
              if (iframe.requestFullscreen) {
                iframe.requestFullscreen();
              }
          });

          menu.appendChild(fullscreenBtn);
          wrapper.appendChild(menu);
        } else {
          const control = document.createElement('div');
          control.id = 'control-box';
          wrapper.appendChild(control);
        }

        popup.style.display = 'flex';
      });
    });

    closeBtn.addEventListener('click', () => {
      iframe.src = "";
      popup.style.display = "none";

      // Clean up UI
      const existingControl = document.getElementById('control-box');
      const existingMenu = document.getElementById('iframe-menu');
      if (existingControl) existingControl.remove();
      if (existingMenu) existingMenu.remove();
    });

    // Add 3D effect to each card
    document.addEventListener('mousemove', e => {
      document.querySelectorAll('.card').forEach($card => {
        const rect = $card.getBoundingClientRect();
        const mouseX = e.clientX;
        const mouseY = e.clientY;

        if (
          mouseX >= rect.left &&
          mouseX <= rect.right &&
          mouseY >= rect.top &&
          mouseY <= rect.bottom
        ) {
          const centerX = mouseX - rect.left - rect.width / 2;
          const centerY = mouseY - rect.top - rect.height / 2;
          const distance = Math.sqrt(centerX ** 2 + centerY ** 2);

          $card.querySelector('img').style.transform = `
            scale3d(1.07, 1.07, 1.07)
            rotate3d(${centerY / 100}, ${-centerX / 100}, 0, ${Math.log(distance + 1) * -2}deg)
          `;
        } else {
          $card.querySelector('img').style.transform = '';
        }
      });
    });
  </script>
</body>
</html>
