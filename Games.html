<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="/Games.css">
    <title>Games Library</title>
   
<script src="/particles.js"></script>
</head>

<body>
    <div id="background"></div>
  <!-- Back button (reloads page) -->
  <button id="back-btn" title="Back"><fa class="fas fa-arrow-left"></fa></button>
  <!-- Start area: centered search and categories -->
  <div id="start-area">
    <pre class="start-logo">  ________                              
 /  _____/_____    _____   ____   ______
/   \  ___\__  \  /     \_/ __ \ /  ___/
\    \_\  \/ __ \|  Y Y  \  ___/ \___ \ 
 \______  (____  |__|_|  /\___  /____  >
        \/     \/      \/     \/     \/ 
</pre>
    <div class="search-container">
      <input type="text" id="game-search" placeholder="Search games..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" autofocus="on">
    </div><div id="category-tabs" class="tabs-container"></div>
    <div id="favorites" class="favorites-container" aria-live="polite"></div>
    
  </div>

  <!-- Library container (hidden until user interacts) -->
  <div class="library-container"></div>
    <div id="iframe-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
        </button>
        <div id="iframe-wrapper" style="position: relative; width: 80vw; height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(255,255,255,0.2);">
            <iframe id="game-frame" allow="fullscreen" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <!-- Menu for games with a custom URL or original games -->
        <div id="iframe-menu" style="display: none; width: 80vw; text-align: center; margin-top: 10px;">
          <h1>ALGOT.FUN</h1>
             <button id="fullscreen-btn" style="padding: 10px 20px; font-size: 1em;">Toggle Fullscreen</button>
        </div>
    </div>
    <div id="particles-js"></div>

<script>
particlesJS("particles-js", {
  particles: {
    number: {
      value: 30,
      density: { enable: true, value_area: 800 }
    },
    color: { value: "#ffffff" },
    shape: { type: "circle" },
    opacity: {
      value: 0.5,
      random: false
    },
    size: {
      value: 3,
      random: true
    },
    line_linked: {
      enable: true,
      distance: 150,
      color: "#ffffff",
      opacity: 0.4,
      width: 1
    },
    move: {
      enable: true,
      speed: 2,
      direction: "none",
      random: false,
      straight: false,
      out_mode: "out",
      attract: { enable: false }
    }
  },
  interactivity: {
    detect_on: "window",
    events: {
      onhover: { enable: true, mode: "repulse" },
      onclick: { enable: true, mode: "none" },
      resize: true
    },
    modes: {
      repulse: { distance: 200, duration: 2 },
      push: { particles_nb: 3 },
      bubble: { distance: 210}
    }
  },
  retina_detect: true
});
</script>
<script>
window.addEventListener('DOMContentLoaded', () => {

  // Attach click handlers to static cards
  document.querySelectorAll('.library-container .game-card').forEach(card => {
  const url = card.dataset.url;
  const direct = card.dataset.direct;
  if (!url) return;

  card.addEventListener('click', () => {
    if (card.dataset.direct === "true") {
      // Open directly in this tab
      window.location.href = url;
    } else {
      // Open in popup
      openGame(url, card.dataset.menu === "true");
    }
  });
});

const searchInput = document.getElementById('game-search');
// Only perform search when Enter is pressed
searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const q = searchInput.value.trim();
    if (q) showSearchResults(q);
    document.getElementById('back-btn').style.display = 'block';
  }
});

// Back button reload behavior
const backBtn = document.getElementById('back-btn');
backBtn.addEventListener('click', () => {
  // Simple reload to return to start state
  location.reload();
});

  document.getElementById('iframe-popup').addEventListener('click', e => {
    if (e.target === e.currentTarget) closePopup();
  });

  // Load dynamic games (fetch once, but render only on user action)
  window.__gamesData = [];
  fetch('games.json')
    .then(res => res.json())
    .then(games => {
      window.__gamesData = games || [];
      const categories = new Set();
      window.__gamesData.forEach(g => { if (g.category) categories.add(g.category); });
      buildCategoryTabs([...categories]);
      renderFavorites();
      // Ensure lazy loader is initialized to observe favorite thumbnails
      initLazyLoader();
    })
    .catch(err => console.error('Failed to load games.json:', err));
});

// Initialize lazy loader on DOMContentLoaded as well
document.addEventListener('DOMContentLoaded', () => initLazyLoader());

window.addEventListener("message", (event) => {
  const trustedOrigins = ["https://your-safe-domain.com"];
  if (!trustedOrigins.includes(event.origin)) {
    return; // Ignore untrusted iframe messages
  }

  // Handle safe messages
  console.log("Got safe message:", event.data);
});

function createGameCard({ title, url, thumbnail, desc, category, showPurpleRect }) {
  const container = document.querySelector('.library-container');
  const card = document.createElement('div');
  card.classList.add('game-card');
  card.dataset.category = category || "Other";
  card.dataset.url = url;
  card.dataset.title = title;
  card.dataset.thumbnail = thumbnail;

  const img = document.createElement('img');
  img.className = 'game-thumb';
  img.alt = title;
  // Use data-src for lazy loading and a tiny transparent placeholder as initial src
  img.setAttribute('data-src', thumbnail);
  img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
  img.loading = 'lazy';

  img.addEventListener('load', () => {
    try {
      const rect = img.getBoundingClientRect();
      const w = rect.width || img.naturalWidth || 340;
      const thickness = Math.max(4, Math.min(18, Math.round(w * 0.03)));
      const blur = Math.max(6, Math.min(36, Math.round(thickness * 1.8)));
      const outerRadius = Math.max(10, Math.round(w * 0.065));
      const innerRadius = Math.max(8, Math.round(outerRadius - thickness));

      card.style.setProperty('--border-thickness', thickness + 'px');
      card.style.setProperty('--glow-blur', blur + 'px');
      card.style.setProperty('--card-radius', outerRadius + 'px');
      card.style.setProperty('--card-inner-radius', innerRadius + 'px');
      img.classList.add('loaded');
      setTimeout(() => card.classList.add('visible'), 20);
    } catch (e) {
      card.style.setProperty('--border-thickness', '6px');
      card.style.setProperty('--glow-blur', '15px');
      card.style.setProperty('--card-radius', '22px');
      card.style.setProperty('--card-inner-radius', '16px');
      img.classList.add('loaded');
      setTimeout(() => card.classList.add('visible'), 20);
    }
  });

  card.appendChild(img);
  card.addEventListener('click', () => {
    window.__currentGame = { url, title, thumbnail, desc, category, showPurpleRect };
    openGame(url, showPurpleRect);
  });
  container.appendChild(card);
  setTimeout(() => { if (!img.classList.contains('loaded')) { img.classList.add('loaded'); card.classList.add('visible'); } }, 800);
  return card;
}

// Lazy loader: IntersectionObserver to swap data-src -> src when image is near viewport.
function initLazyLoader() {
  if (window._lazyLoaderInited) return;
  const loadImage = (img) => {
    if (!img) return;
    const src = img.getAttribute('data-src');
    if (!src) return;
    img.src = src;
    img.removeAttribute('data-src');
  };

  if ('IntersectionObserver' in window) {
    const io = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          observer.unobserve(img);
          loadImage(img);
        }
      });
    }, { root: null, rootMargin: '200px', threshold: 0.01 });

    // Observe existing and future images with data-src
    const observeAll = () => document.querySelectorAll('img[data-src]').forEach(img => io.observe(img));
    // Observe current ones now
    observeAll();
    // Also observe newly added images periodically (e.g., during progressive render)
    const mo = new MutationObserver((mutations) => { observeAll(); });
    mo.observe(document.body, { childList: true, subtree: true });
  } else {
    // Fallback: on scroll/resize load images in viewport
    const checkAndLoad = () => {
      document.querySelectorAll('img[data-src]').forEach(img => {
        const rect = img.getBoundingClientRect();
        if (rect.top < window.innerHeight + 200 && rect.bottom > -200) {
          const src = img.getAttribute('data-src');
          if (src) { img.src = src; img.removeAttribute('data-src'); }
        }
      });
    };
    ['scroll','resize','orientationchange'].forEach(ev => window.addEventListener(ev, checkAndLoad, { passive: true }));
    // Run once to catch images already in view
    setTimeout(checkAndLoad, 100);
  }
  window._lazyLoaderInited = true;
}

// Favorites helpers
function loadFavorites() { try { return JSON.parse(localStorage.getItem('gf_favs') || '[]'); } catch(e) { return []; } }
function saveFavorites(arr) { localStorage.setItem('gf_favs', JSON.stringify(arr)); }
function isFavorited(url) { return loadFavorites().some(f => f.url === url); }
function toggleFavoriteForCurrent() {
  const g = window.__currentGame;
  if (!g) return;
  const favs = loadFavorites();
  const idx = favs.findIndex(f => f.url === g.url);
  if (idx >= 0) favs.splice(idx, 1);
  else favs.unshift({ url: g.url, title: g.title, thumbnail: g.thumbnail, category: g.category, showPurpleRect: !!g.showPurpleRect });
  saveFavorites(favs);
  renderFavorites();
}
function renderFavorites() {
  const container = document.getElementById('favorites');
  if (!container) return;
  const favs = loadFavorites();
  container.innerHTML = '';
  favs.forEach(f => {
    const el = document.createElement('div');
    el.className = 'favorite-item';
    el.title = f.title;
    const img = document.createElement('img');
    img.setAttribute('data-src', f.thumbnail);
    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    img.alt = f.title;
    el.appendChild(img);
    el.addEventListener('click', () => {
      // determine showPurpleRect: prefer stored value, otherwise infer from games.json
      const stored = typeof f.showPurpleRect !== 'undefined' ? !!f.showPurpleRect : undefined;
      const inferred = getShowPurpleForUrl(f.url);
      const showPurple = (typeof stored !== 'undefined') ? stored : inferred;
      window.__currentGame = { url: f.url, title: f.title, thumbnail: f.thumbnail, category: f.category, showPurpleRect: showPurple };
      openGame(f.url, !!showPurple);
    });
    container.appendChild(el);
  });
  // Ensure lazy loader is observing newly added favorite images
  initLazyLoader();
}

// Try to infer showPurpleRect setting for a URL by looking up games.json data
function getShowPurpleForUrl(url) {
  const games = window.__gamesData || [];
  for (let g of games) {
    const candidate = g.customurl ? g.customurl : `https://games.crazygames.com/en_US/${g.gameid}/index.html?skipPrerollFirstSession=true`;
    if (candidate === url) return !!(!g.customurl); // showPurpleRect = !customurl
  }
  return false;
}

function buildCategoryTabs(categories) {
  const tabsContainer = document.getElementById('category-tabs');
  const allBtn = document.createElement('button');
  allBtn.innerHTML = '<i class="fa-solid fa-dice-five"></i>';
  allBtn.dataset.category = 'All';
  allBtn.classList.add('active');
  allBtn.addEventListener('click', () => showCategory('All'));
  tabsContainer.appendChild(allBtn);

  // icon map (uppercased keys)
  const iconMap = {
    'CASUAL': 'fa-solid fa-gamepad',
    'DRIVING': 'fa-solid fa-car',
    'PUZZLE': 'fa-solid fa-puzzle-piece',
    'SPORTS': 'fa-solid fa-basketball-ball',
    'IO': 'fa-solid fa-yin-yang',
    'IDLE': 'fa-solid fa-coffee',
    'STICKMAN': 'fa-solid fa-person-running'
  };

  // Add one button per category
  categories.forEach(cat => {
    const key = (cat || '').toString().toUpperCase();
    const iconClass = iconMap[key];
    const btn = document.createElement('button');
    btn.dataset.category = cat;
    if (iconClass) {
      btn.classList.add('icon');
      btn.innerHTML = `<i class="${iconClass}" aria-hidden="true"></i>`;
      btn.title = cat;
      btn.setAttribute('aria-label', cat);
    } else {
      btn.textContent = cat;
    }
    btn.addEventListener('click', () => showCategory(cat));
    tabsContainer.appendChild(btn);
  });
}

// Render functions: showCategory and showSearchResults
function showCategory(category) {
  // Set active state on tabs (compare data-category first)
  document.querySelectorAll('#category-tabs button').forEach(b => b.classList.remove('active'));
  [...document.querySelectorAll('#category-tabs button')].find(b => (b.dataset.category && b.dataset.category === category) || b.textContent === category)?.classList.add('active');

  // Populate library with matching games
  const container = document.querySelector('.library-container');
  container.innerHTML = '';
  const games = window.__gamesData || [];
  // Cancel any previous progressive rendering
  if (window.__renderTimer) {
    clearInterval(window.__renderTimer);
    window.__renderTimer = null;
  }

  if (category === 'All') {
    // shuffle and progressively render to avoid loading all at once
    const shuffled = games.slice();
    // Fisher-Yates shuffle
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    const batchSize = 6; // how many cards per interval
    let index = 0;
    window.__renderTimer = setInterval(() => {
      const end = Math.min(index + batchSize, shuffled.length);
      for (; index < end; index++) {
        const g = shuffled[index];
        const url = g.customurl ? g.customurl : `https://games.crazygames.com/en_US/${g.gameid}/index.html?skipPrerollFirstSession=true`;
        const title = g.gameid ? g.gameid.split('-').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : (g.title || 'Game');
        createGameCard({ title, url, thumbnail: g.thumbnail, desc: g.desc, category: g.category, showPurpleRect: !g.customurl });
      }
      if (index >= shuffled.length) {
        clearInterval(window.__renderTimer);
        window.__renderTimer = null;
      }
    }, 120); // every 120ms render next batch
  } else {
    const toShow = games.filter(g => g.category === category);
    toShow.forEach(g => {
      const url = g.customurl ? g.customurl : `https://games.crazygames.com/en_US/${g.gameid}/index.html?skipPrerollFirstSession=true`;
      const title = g.gameid ? g.gameid.split('-').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : (g.title || 'Game');
      createGameCard({ title, url, thumbnail: g.thumbnail, desc: g.desc, category: g.category, showPurpleRect: !g.customurl });
    });
  }
  // Reveal library and hide start area
  document.querySelector('.library-container').classList.add('visible');
  document.getElementById('start-area').style.display = 'none';
  // show back button
  document.getElementById('back-btn').style.display = 'block';
}

function showSearchResults(query) {
  const q = (query || '').toLowerCase().trim();
  const container = document.querySelector('.library-container');
  container.innerHTML = '';
  const games = window.__gamesData || [];
  const results = games.filter(g => {
    const title = (g.gameid || g.title || '').toLowerCase();
    const desc = (g.desc || '').toLowerCase();
    return title.includes(q) || desc.includes(q);
  });
  results.forEach(g => {
    const url = g.customurl ? g.customurl : `https://games.crazygames.com/en_US/${g.gameid}/index.html?skipPrerollFirstSession=true`;
    const title = g.gameid ? g.gameid.split('-').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : (g.title || 'Game');
    createGameCard({ title, url, thumbnail: g.thumbnail, desc: g.desc, category: g.category, showPurpleRect: !g.customurl });
  });
  document.querySelector('.library-container').classList.add('visible');
  document.getElementById('start-area').style.display = 'none';
  // show back button
  document.getElementById('back-btn').style.display = 'block';
}

function filterByCategory(category) {
  // Set active state
  document.querySelectorAll('#category-tabs button').forEach(b => b.classList.remove("active"));
  [...document.querySelectorAll('#category-tabs button')].find(b => b.textContent === category)?.classList.add("active");

  // Show/hide cards
  document.querySelectorAll('.library-container .game-card').forEach(card => {
    if (category === "All" || card.dataset.category === category) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}


window.mobileCheck = function() {
  let check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};

/* ðŸ”¥ Single openGame function */
function openGame(url, showPurpleRect = false) {
  const popup = document.getElementById('iframe-popup');
  const wrapper = document.getElementById('iframe-wrapper');
  const iframe = document.getElementById('game-frame');
  // Clean old UI
  document.getElementById('control-box')?.remove();
  document.getElementById('iframe-menu')?.remove();

  iframe.src = url;
  popup.style.display = 'flex';
  document.body.style.overflowY = 'hidden';

  const isMobile = window.mobileCheck();
  if (isMobile) {
    let currentUrl = new URL(url); 
    currentUrl.searchParams.set('v', '1.337'); // Add or update the parameter
    location.replace(currentUrl.toString()); // Navigate to the new URL
  }

  // Set wrapper styles
  wrapper.style.width = isMobile ? '100vw' : '80vw';
  wrapper.style.height = isMobile ? '100vh' : '80vh';
  wrapper.style.borderRadius = isMobile ? '0' : '12px';
  wrapper.style.boxShadow = isMobile ? 'none' : '0 0 20px rgba(255,255,255,0.2)'; 



  // Purple control box for desktop
  if (!isMobile && showPurpleRect) {
    const control = document.createElement('div');
    control.id = 'control-box';
    control.style.position = 'absolute';
    control.style.bottom = '0';
    control.style.left = '0';
    control.style.width = '100%';
    control.style.height = '45px';
    control.style.backgroundColor = '#000000';
    control.style.zIndex = '10';
    wrapper.appendChild(control);
  }

  if (!isMobile) {
    // Desktop â†’ add fullscreen menu button
    scrollTo(0, 0);

    const menu = document.createElement('div');
    menu.id = 'iframe-menu';
    menu.style.position = 'absolute';
    menu.style.bottom = '2px';
    menu.style.right = '2px';
    menu.style.zIndex = '11';
    const menu2 = document.createElement('div');
    menu2.id = 'iframe-menu2';
    menu2.style.position = 'absolute';
    menu2.style.bottom = '2px';
    menu2.style.left = '2px';
    menu2.style.zIndex = '11';
    

    const fullscreenBtn = document.createElement('button');
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
    fullscreenBtn.style.background = 'none';
    fullscreenBtn.style.fontSize = '2em';
    fullscreenBtn.style.color = 'white';
    fullscreenBtn.style.border = 'none';
    fullscreenBtn.style.cursor = 'pointer';
    const Tag = document.createElement('h1');
    Tag.innerText = 'ALGOT.FUN';
    Tag.style.color = 'white';
    Tag.style.fontSize = '2em';
    Tag.style.margin = '0';
    menu2.appendChild(Tag);
    fullscreenBtn.addEventListener('click', e => {
      e.stopPropagation();
      if (document.fullscreenElement) {
        document.exitFullscreen();
        iframe.style.height = '100%';
      } else {
        wrapper.requestFullscreen().then(() => {
          wrapper.style.borderRadius = '0';
          document.getElementById('iframe-menu').style.display = 'none';
          const controlBox = document.getElementById('control-box');
          if (controlBox) iframe.style.height = 'calc(100vh + 45px)';
          if (controlBox) controlBox.style.display = 'none';
        });
      }
    });

    const favBtn = document.createElement('button');
    favBtn.id = 'fav-btn';
    favBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
    favBtn.style.background = 'none';
    favBtn.style.fontSize = '1.5em';
    favBtn.style.color = 'white';
    favBtn.style.border = 'none';
    favBtn.style.cursor = 'pointer';
    favBtn.style.marginLeft = '8px';
    favBtn.addEventListener('click', e => {
      e.stopPropagation();
      toggleFavoriteForCurrent();
      // update icon
      const heart = favBtn.querySelector('i');
      if (window.__currentGame && isFavorited(window.__currentGame.url)) {
        heart.className = 'fa-solid fa-heart';
      } else {
        heart.className = 'fa-regular fa-heart';
      }
    });



    // set initial favorite icon state based on current game
    try {
      const heart = favBtn.querySelector('i');
      if (window.__currentGame && isFavorited(window.__currentGame.url)) heart.className = 'fa-solid fa-heart';
      else heart.className = 'fa-regular fa-heart';
    } catch (e) {}
    menu.appendChild(favBtn);
    menu.appendChild(fullscreenBtn);
  wrapper.appendChild(menu);
  // left-side tag/menu
  menu2.style.padding = '6px 10px';
  menu2.style.display = 'flex';
  menu2.style.alignItems = 'center';
  menu2.style.justifyContent = 'center';
  wrapper.appendChild(menu2);
  } else {
    // Mobile â†’ auto fullscreen with setTimeout
    setTimeout(() => {
      wrapper.requestFullscreen().catch(() => {});
    }, 1000);
  }

  // Single fullscreenchange listener
  if (!window._fullscreenListenerAdded) {
    document.addEventListener('fullscreenchange', () => {
      const controlBox = document.getElementById('control-box');
      const menu = document.getElementById('iframe-menu');
      if (!document.fullscreenElement) {
        // Restore styles
        wrapper.style.borderRadius = window.mobileCheck() ? '0' : '12px';
        if (menu) menu.style.display = 'block';
        if (controlBox) controlBox.style.display = 'block';
        iframe.style.height = '100%';
        // If mobile and fullscreen exited, close popup
        if (window.mobileCheck()) closePopup();
      }
    });
    window._fullscreenListenerAdded = true;
  }
}

function closePopup() {
  const popup = document.getElementById('iframe-popup');
  const iframe = document.getElementById('game-frame');
  iframe.src = '';
  popup.style.display = 'none';
  document.getElementById('control-box')?.remove();
  document.getElementById('iframe-menu')?.remove();
  document.body.style.overflowY = 'scroll';
}
</script>




</body>
</html>