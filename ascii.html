<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Image → ASCII Art — Advanced</title>
	<style>
		:root{--bg:#000000;--panel:#0000007e;--muted:#9aa3b2;--accent:#7dd3fc}
		html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
		body{background-color: #000000; color:#e6eef6;padding:20px}
		.wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:18px}
		header{grid-column:1/-1;display:flex;align-items:center;gap:12px}
		header h1{margin:0;font-size:18px}
		.panel{background:var(--panel);padding:14px;border-radius:10px; backdrop-filter: blur(10px);}
		.controls{display:flex;flex-direction:column;gap:12px}
		label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
		input[type=file],input[type=text],select,button{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
		.row{display:flex;gap:8px}
		.row > *{flex:1}
		.small{font-size:12px;padding:6px}
		.output{min-height:520px;overflow:auto;padding:16px;white-space:pre;background:#020204;border-radius:10px;font-family:monospace;font-size:8px;line-height:7px}
		.toolbar{display:flex;gap:8px;align-items:center}
		.muted{color:var(--muted);font-size:12px}
		.drag{border:2px dashed rgba(255,255,255,.04);padding:10px;border-radius:8px;text-align:center;color:var(--muted)}
		.previewCanvas{display:none}
		.output .line{font-family:monospace;white-space:pre}
		.actions{display:flex;gap:8px}
		.footer{grid-column:1/-1;color:var(--muted);font-size:12px;margin-top:8px}
		@media(max-width:900px){.wrap{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}}
	</style>
</head>
<body>
    <iframe src="topo.html" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;border: none;"></iframe>
	<div class="wrap">
		<header>
			<h1>Image → ASCII (advanced)</h1>
		</header>

		<div class="panel controls">
			<div>
				<label>Upload Image</label>
				<input id="file" type="file" accept="image/*" />
			</div>

			<div>
				<label>Or image URL</label>
				<div class="row"><input id="url" type="text" placeholder="https://..." /><button id="loadUrl" class="small">Load</button></div>
			</div>

			<div class="drag" id="drop">Drag & drop image here</div>

			<div>
				<label>Character Set</label>
				<select id="charset">
					<option value="@%#*+=-:.   ">Default (dense)</option>
					<option value="$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft/\\|()1{}[]?-_+~<>i!lI;:,\"^`'. "  >High detail</option>
					<option value="@#S%?*+;:,.   ">Simple</option>
					<option value="   .:-=+*#%@">Reversed</option>
				</select>
			</div>

			<div>
				<label>Width (characters)</label>
				<input id="width" type="range" min="20" max="400" value="160" />
				<div class="muted" id="widthVal">160</div>
			</div>

			<div>
				<label>Scale (font aspect compensation)</label>
				<input id="scale" type="range" min="0.2" max="2" step="0.01" value="0.55" />
				<div class="muted" id="scaleVal">0.55</div>
			</div>

			<div class="row">
				<div>
					<label>Invert</label>
					<select id="invert"><option value="false">Off</option><option value="true">On</option></select>
				</div>
				<div>
					<label>Color</label>
					<select id="color"><option value="false">Grayscale</option><option value="true">Color</option></select>
				</div>
			</div>

			<div>
				<label>Brightness</label>
				<input id="brightness" type="range" min="-100" max="100" value="0" />
			</div>

			<div>
				<label>Contrast</label>
				<input id="contrast" type="range" min="-100" max="100" value="0" />
			</div>

			<div class="toolbar">
				<button id="generate">Generate</button>
				<div class="actions">
					<button id="copy">Copy Text</button>
					<button id="downloadTxt">Download .txt</button>
				</div>
			</div>

			<div class="muted">Tip: use denser character sets for more detail. For SVG, the page will rasterize the vector before conversion.</div>
		</div>

		<div class="panel">
			<div class="panel" style="padding:12px;margin-bottom:10px">
				<div class="muted">Output</div>
				<div id="output" class="output" spellcheck="false"></div>
			</div>
			<canvas id="preview" class="previewCanvas"></canvas>
		</div>
	</div>

	<script>
		// Utilities and UI
		const fileInput = document.getElementById('file');
		const drop = document.getElementById('drop');
		const urlInput = document.getElementById('url');
		const loadUrlBtn = document.getElementById('loadUrl');
		const charsetSel = document.getElementById('charset');
		const widthRange = document.getElementById('width');
		const widthVal = document.getElementById('widthVal');
		const scaleRange = document.getElementById('scale');
		const scaleVal = document.getElementById('scaleVal');
		const invertSel = document.getElementById('invert');
		const colorSel = document.getElementById('color');
		const brightnessRange = document.getElementById('brightness');
		const contrastRange = document.getElementById('contrast');
		const generateBtn = document.getElementById('generate');
		const outputEl = document.getElementById('output');
		const preview = document.getElementById('preview');
		const copyBtn = document.getElementById('copy');
		const downloadTxt = document.getElementById('downloadTxt');
		const downloadHtml = document.getElementById('downloadHtml');
		const downloadPng = document.getElementById('downloadPng');

		widthRange.addEventListener('input', ()=> widthVal.textContent = widthRange.value);
		scaleRange.addEventListener('input', ()=> scaleVal.textContent = scaleRange.value);

		fileInput.addEventListener('change', e=>{
			const f = e.target.files && e.target.files[0]; if (f) loadFileImage(f);
		});

		loadUrlBtn.addEventListener('click', ()=>{
			const url = urlInput.value.trim(); if (!url) return; loadImageFromURL(url);
		});

		['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='var(--accent)'}));
		['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='rgba(255,255,255,.04)'}));
		drop.addEventListener('drop', e=>{const f=e.dataTransfer.files[0]; if(f) loadFileImage(f)});

		async function loadFileImage(file){
			if (file.type === 'image/svg+xml'){
				const text = await file.text();
				const svgUrl = URL.createObjectURL(new Blob([text],{type:'image/svg+xml'}));
				loadImageFromSrc(svgUrl);
			} else {
				const url = URL.createObjectURL(file);
				loadImageFromSrc(url);
			}
		}

		function loadImageFromURL(url){
			// For remote SVGs and cross-origin images, try to fetch and convert to blob to avoid tainting canvas
			fetch(url).then(r=>r.blob()).then(blob=>{
				const obj = URL.createObjectURL(blob);
				loadImageFromSrc(obj);
			}).catch(()=>{loadImageFromSrc(url)});
		}

		function loadImageFromSrc(src){
			const img = new Image();
			img.crossOrigin = 'Anonymous';
			img.onload = ()=>{ window._loadedImage = img; renderToAscii(img); }
			img.onerror = e=>alert('Failed to load image. Check CORS or the URL.');
			img.src = src;
		}

		function applyBrightnessContrast(v, contrast){
			// v in [0,255], contrast in [-100,100]
			const c = (contrast/100);
			return Math.min(255, Math.max(0, ((v - 128) * (1 + c)) + 128 + (v*(brightnessRange.value/100))));
		}

		function renderToAscii(img){
			const ctx = preview.getContext('2d');
			const targetWidth = parseInt(widthRange.value,10);
			const scale = parseFloat(scaleRange.value);
			const aspect = img.height / img.width;
			const targetHeight = Math.max(1, Math.round(targetWidth * aspect * scale));
			preview.width = targetWidth; preview.height = targetHeight;
			ctx.drawImage(img,0,0,preview.width,preview.height);
			let data = ctx.getImageData(0,0,preview.width,preview.height).data;

			const charset = charsetSel.value;
			const invert = invertSel.value === 'true';
			const useColor = colorSel.value === 'true';
			const brightness = parseInt(brightnessRange.value,10);
			const contrast = parseInt(contrastRange.value,10);

			// Build ascii lines
			const lines = [];
			for(let y=0;y<preview.height;y++){
				let line='';
				for(let x=0;x<preview.width;x++){
					const i = (y*preview.width + x) * 4;
					let r = data[i], g = data[i+1], b = data[i+2];
					// apply brightness/contrast
					r = applyBC(r, brightness, contrast);
					g = applyBC(g, brightness, contrast);
					b = applyBC(b, brightness, contrast);
					const lum = 0.2126*r + 0.7152*g + 0.0722*b;
					const t = invert ? 255 - lum : lum;
					const idx = Math.floor((t/255) * (charset.length - 1));
					const ch = charset[idx] || ' ';
					if (useColor){
						const span = `<span style="color:rgb(${r},${g},${b})">${escapeHtml(ch)}</span>`;
						line += span;
					} else {
						line += ch;
					}
				}
				lines.push(line);
			}

			// Render output
			if (useColor){
				outputEl.innerHTML = lines.map(l=>`<div class=\"line\">${l}</div>`).join('\n');
				outputEl.style.fontSize = '8px';
				outputEl.style.lineHeight = '7px';
			} else {
				outputEl.textContent = lines.map(l=>stripHtml(l)).join('\n');
				outputEl.style.fontSize = '8px';
				outputEl.style.lineHeight = '7px';
			}
			// store last result
			window._lastAscii = {lines, useColor};
		}

		function applyBC(v, brightness, contrast){
			// brightness [-100,100], contrast [-100,100]
			let val = v + (brightness/100)*255;
			const c = (contrast/100);
			val = ((val - 128) * (1 + c)) + 128;
			return Math.max(0, Math.min(255, Math.round(val)));
		}

		function escapeHtml(s){
			return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');
		}
		function stripHtml(s){ return s.replace(/<[^>]*>/g,''); }

		generateBtn.addEventListener('click', ()=>{
			if (window._loadedImage) renderToAscii(window._loadedImage);
			else alert('Please load an image first (upload or URL)');
		});

		copyBtn.addEventListener('click', ()=>{
			const text = window._lastAscii ? (window._lastAscii.useColor ? outputEl.innerText : outputEl.textContent) : outputEl.textContent;
			navigator.clipboard.writeText(text).then(()=>{ copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy Text',1200);});
		});

		downloadTxt.addEventListener('click', ()=>{
			if (!window._lastAscii) return alert('Generate first');
			const text = window._lastAscii.useColor ? outputEl.innerText : outputEl.textContent;
			const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
			const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ascii.txt'; a.click();
		});

		downloadHtml.addEventListener('click', ()=>{
			if (!window._lastAscii) return alert('Generate first');
			const html = `<!doctype html><meta charset=\"utf-8\"><style>body{background:#000;color:#fff;font-family:monospace;white-space:pre}</style><pre>${outputEl.innerHTML}</pre>`;
			const blob = new Blob([html],{type:'text/html;charset=utf-8'});
			const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ascii.html'; a.click();
		});

		downloadPng.addEventListener('click', ()=>{
			if (!window._lastAscii) return alert('Generate first');
			// Render text to a canvas and export PNG
			const lines = window._lastAscii.lines.map(l=> stripHtml(l));
			const fontSize = 8; const lineHeight = 7;
			const cols = lines[0] ? lines[0].length : 0;
			const canvas = document.createElement('canvas');
			canvas.width = cols * (fontSize*0.6);
			canvas.height = lines.length * lineHeight;
			const ctx = canvas.getContext('2d');
			ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
			ctx.font = `${fontSize}px monospace`;
			ctx.fillStyle = '#fff';
			for(let i=0;i<lines.length;i++) ctx.fillText(lines[i], 0, (i+1)*lineHeight);
			canvas.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ascii.png'; a.click(); });
		});

		// small helper: if user pastes an image from clipboard
		window.addEventListener('paste', e=>{
			const items = e.clipboardData && e.clipboardData.items; if(!items) return;
			for(const it of items){ if (it.type.startsWith('image/')){ const f = it.getAsFile(); loadFileImage(f); break; } }
		});

		// initialize sample: draw nothing yet
	</script>
</body>
</html>

